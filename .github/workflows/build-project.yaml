name: Build Project
on:
  workflow_call:
    outputs:
          pluginName:
            description: "Plugin Name from buildspec.json"
            value: ${{ jobs.windows-build.outputs.NAME }}
          pluginVersion:
            description: "Plugin Version from buildspec.json"
            value: ${{ jobs.windows-build.outputs.VERSION }}
jobs:
  windows-build:
    name: Build Windows x64
    runs-on: windows-2022

    outputs:
      NAME: ${{ steps.config.outputs.NAME }}
      VERSION: ${{ steps.config.outputs.VERSION }}

    defaults:
      run:
        shell: pwsh
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Configure Environment
        id: config
        run: |
          $Json = Get-Content buildspec.json -Raw | ConvertFrom-Json
          echo "NAME=$($Json.name)" >> $env:GITHUB_OUTPUT
          echo "VERSION=$($Json.version)" >> $env:GITHUB_OUTPUT
          
          if ($env:GITHUB_REF -match "refs/tags/") {
            echo "BUILD_TYPE=Release" >> $env:GITHUB_OUTPUT
            Write-Host "Build Mode: RELEASE (Tag Detected)"
          } else {
            echo "BUILD_TYPE=RelWithDebInfo" >> $env:GITHUB_OUTPUT
            Write-Host "Build Mode: RELWITHDEBINFO (Dev Build)"
          }

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.3'
          arch: 'win64_msvc2019_64'
          cache: 'false'

      - name: Configure CMake
        run: cmake --preset windows-x64

      - name: Build
        run: cmake --build --preset windows-release --config ${{ steps.config.outputs.BUILD_TYPE }}

      - name: Stage Artifacts
        run: |
          $StageDir = "staging"
          New-Item -ItemType Directory -Force -Path $StageDir
          
          $PluginName = "${{ steps.config.outputs.NAME }}"
          
          Write-Host "Artifacts aranÄ±yor: $PluginName.dll ..."
          
          $DllFile = Get-ChildItem -Path "build" -Filter "$PluginName.dll" -Recurse | Select-Object -First 1
          
          if ($DllFile) {
              Write-Host "DLL Bulundu: $($DllFile.FullName)"
              Copy-Item $DllFile.FullName -Destination $StageDir
          } else {
              Write-Warning "DLL not found! Build folder:"
              Get-ChildItem -Path "build" -Recurse | Select-Object FullName
              Write-Error "DLL file ($PluginName.dll) not found inside build directory!"
          }

          $PdbFile = Get-ChildItem -Path "build" -Filter "$PluginName.pdb" -Recurse | Select-Object -First 1
          if ($PdbFile) {
              Write-Host "PDB Found: $($PdbFile.FullName)"
              Copy-Item $PdbFile.FullName -Destination $StageDir
          }

          if (Test-Path "data") {
              Write-Host "Data folder copying..."
              Copy-Item "data" -Destination "$StageDir/data" -Recurse
          }
          
          Write-Host "Packaging Completed. Contents:"
          Get-ChildItem $StageDir -Recurse

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.config.outputs.NAME }}-${{ steps.config.outputs.VERSION }}-windows-x64
          path: staging/*